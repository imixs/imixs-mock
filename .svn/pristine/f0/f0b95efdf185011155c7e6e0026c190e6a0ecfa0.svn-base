package org.imixs.workflow.jee.ejb;

import javax.naming.InitialContext;

import org.imixs.workflow.ItemCollection;
import org.imixs.workflow.exceptions.AccessDeniedException;
import org.imixs.workflow.exceptions.ProcessingErrorException;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.experimental.categories.Category;

import com.sun.appserv.security.ProgrammaticLogin;

/**
 * Test class for WorkflowService
 * 
 * @author rsoika
 * 
 */
public class TestWorkflowService {
	WorkflowServiceRemote workflowService = null;

	@Before
	public void setup() {

		try {
			// set jndi name
			String ejbName = "java:global/imixs-workflow-web-sample-0.0.5-SNAPSHOT/WorkflowService!org.imixs.workflow.jee.ejb.WorkflowServiceRemote";
 
						 
			// setup programmatic login for GlassFish 3
			System.setProperty("java.security.auth.login.config", "/home/rsoika/eclipse_37/imixs-workflow/imixs-workflow-engine/src/test/resources/auth.conf"); 
			ProgrammaticLogin programmaticLogin = new ProgrammaticLogin(); 
			// set password
			programmaticLogin.login("Anna", "anna".toCharArray()); 
			//programmaticLogin.l
			
			InitialContext ic = new InitialContext();
			workflowService = (WorkflowServiceRemote) ic.lookup(ejbName);

		} catch (Exception e) {
			e.printStackTrace();
			workflowService = null;
		}
	}

	@Test
	@Category(org.imixs.workflow.jee.ejb.EntityServiceRemote.class)
	public void testService() {

		Assert.assertNotNull(workflowService);

	}

	
	@Test
	@Category(org.imixs.workflow.jee.ejb.EntityServiceRemote.class)
	public void testProcessWorkitem() {
		
		ItemCollection itemcol=new ItemCollection();
		itemcol.replaceItemValue("txtName","Anna");
		itemcol.replaceItemValue("$processid",10);
		itemcol.replaceItemValue("$activityid",10);

		try {
			itemcol=workflowService.processWorkItem(itemcol);
		} catch (AccessDeniedException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (ProcessingErrorException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		Assert.assertEquals("1.0.0", itemcol.getItemValueString("$ModelVersion"));

	}

}
